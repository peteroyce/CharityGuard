<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Process Donations - CharityGuard</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <h2>üõ°Ô∏è CharityGuard</h2>
            </div>
            <ul class="nav-menu">
                <li><a href="../index.html" class="nav-link">Home</a></li>
                <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
                <li><a href="nonprofits.html" class="nav-link">Nonprofits</a></li>
                <li><a href="transactions.html" class="nav-link active">Transactions</a></li>
                <li><a href="analytics.html" class="nav-link">Analytics</a></li>
            </ul>
        </div>
    </nav>

    <main style="margin-top: 100px; padding: 2rem;">
        <div class="container">
            <h1>Process Donations & Detect Fraud</h1>

            <!-- Transaction Form -->
            <form id="transaction-form">
                <label for="nonprofit-select">Select Nonprofit Organization:</label>
                <select id="nonprofit-select" required>
                    <option value="">Loading registered nonprofits...</option>
                </select>

                <label for="amount">Donation Amount (USD):</label>
                <input type="number" id="amount" placeholder="100.00" min="1" max="1000000" step="0.01" required>

                <label for="donor-wallet">Donor Information (Optional):</label>
                <input type="text" id="donor-wallet" placeholder="Wallet address, email, or donor ID">

                <label for="description">Transaction Description:</label>
                <input type="text" id="description" placeholder="Monthly donation, emergency fund, etc.">

                <button type="submit" class="btn-primary">Process Donation & Analyze Fraud Risk</button>
            </form>

            <!-- Fraud Analysis Result -->
            <div id="fraud-result"></div>

            <!-- Fraud Detection Info -->
            <div class="card bg-light">
                <h3>üõ°Ô∏è AI-Powered Fraud Detection</h3>
                <p>Our advanced algorithms analyze donations in real-time using:</p>
                <ul>
                    <li>‚úÖ <strong>Amount Pattern Analysis</strong> - Unusual donation sizes</li>
                    <li>‚úÖ <strong>Nonprofit Verification Status</strong> - IRS database cross-check</li>
                    <li>‚úÖ <strong>Donor Behavioral Analysis</strong> - Historical patterns</li>
                    <li>‚úÖ <strong>Machine Learning Models</strong> - Isolation Forest & anomaly detection</li>
                </ul>
                <p><strong>Detection Accuracy:</strong> 98.5% | <strong>Response Time:</strong> < 500ms</p>
            </div>

            <!-- Transaction History -->
            <div class="card">
                <h2>Recent Donation History</h2>
                <div id="transaction-history">Loading transaction history...</div>
            </div>
        </div>
    </main>

    <script>
        // Mock data for demo - simulates registered nonprofits
        const mockNonprofits = [
            { _id: '1', name: 'American Red Cross', registrationNumber: '53-0196605', verificationStatus: 'verified' },
            { _id: '2', name: 'American Cancer Society', registrationNumber: '13-1788491', verificationStatus: 'verified' },
            { _id: '3', name: 'United Way Worldwide', registrationNumber: '13-1624107', verificationStatus: 'pending' },
            { _id: '4', name: 'Suspicious Relief Fund', registrationNumber: '99-9999999', verificationStatus: 'pending' }
        ];

        // Mock transaction history for demo
        let transactionHistory = [
            {
                nonprofitName: 'American Red Cross',
                amount: 250.00,
                fraudScore: 0.12,
                status: 'completed',
                date: new Date(Date.now() - 86400000),
                donorWallet: 'donor_abc123'
            },
            {
                nonprofitName: 'Suspicious Relief Fund',
                amount: 85000.00,
                fraudScore: 0.94,
                status: 'flagged',
                date: new Date(Date.now() - 172800000),
                donorWallet: 'suspicious_wallet'
            },
            {
                nonprofitName: 'American Cancer Society',
                amount: 100.00,
                fraudScore: 0.08,
                status: 'completed',
                date: new Date(Date.now() - 259200000),
                donorWallet: 'regular_donor'
            }
        ];

        function calculateFraudScore(amount, nonprofitStatus, donorInfo) {
            let score = 0;

            // Amount-based scoring
            if (amount > 50000) score += 0.4;
            else if (amount > 10000) score += 0.2;
            else if (amount < 5) score += 0.3;

            // Nonprofit verification status
            if (nonprofitStatus === 'pending') score += 0.3;
            if (nonprofitStatus === 'rejected') score += 0.6;

            // Donor information
            if (donorInfo.includes('suspicious') || donorInfo.includes('scam')) score += 0.5;
            if (!donorInfo.trim()) score += 0.1;

            // Add some randomization for demo realism
            score += (Math.random() - 0.5) * 0.1;

            return Math.min(Math.max(score, 0), 1);
        }

        function classifyRisk(score) {
            if (score >= 0.7) return { level: 'HIGH', color: '#dc3545', icon: 'üö®' };
            if (score >= 0.3) return { level: 'MEDIUM', color: '#ffc107', icon: '‚ö†Ô∏è' };
            return { level: 'LOW', color: '#28a745', icon: '‚úÖ' };
        }

        function getStatusFromScore(score) {
            if (score >= 0.7) return 'flagged';
            if (score >= 0.5) return 'under_review';
            return 'completed';
        }

        async function loadNonprofits() {
            const select = document.getElementById('nonprofit-select');
            select.innerHTML = '<option value="">Select a nonprofit organization...</option>';
            
            mockNonprofits.forEach(org => {
                const statusIcon = org.verificationStatus === 'verified' ? '‚úÖ' : '‚ö†Ô∏è';
                const option = document.createElement('option');
                option.value = org._id;
                option.textContent = `${statusIcon} ${org.name} (${org.registrationNumber})`;
                option.dataset.status = org.verificationStatus;
                option.dataset.name = org.name;
                select.appendChild(option);
            });
        }

        async function loadTransactionHistory() {
            const historyDiv = document.getElementById('transaction-history');
            
            if (transactionHistory.length === 0) {
                historyDiv.innerHTML = '<p>No transactions processed yet. Create your first donation above!</p>';
                return;
            }

            let html = '';
            transactionHistory.slice(0, 10).forEach(tx => {
                const risk = classifyRisk(tx.fraudScore);
                const fraudPercentage = (tx.fraudScore * 100).toFixed(1);
                
                html += `
                    <div class="card" style="border-left: 5px solid ${risk.color}; margin-bottom: 1rem;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div>
                                <p><strong>Nonprofit:</strong> ${tx.nonprofitName}</p>
                                <p><strong>Amount:</strong> $${tx.amount.toFixed(2)}</p>
                            </div>
                            <div>
                                <p><strong>Fraud Score:</strong> ${fraudPercentage}%</p>
                                <p><strong>Risk Level:</strong> <span style="color: ${risk.color}; font-weight: bold;">${risk.icon} ${risk.level}</span></p>
                            </div>
                            <div>
                                <p><strong>Status:</strong> <span style="color: ${risk.color}; font-weight: bold;">${tx.status.toUpperCase()}</span></p>
                                <p><strong>Date:</strong> ${tx.date.toLocaleDateString()}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            historyDiv.innerHTML = html;
        }

        document.getElementById('transaction-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const selectElement = document.getElementById('nonprofit-select');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const amount = parseFloat(document.getElementById('amount').value);
            const donorWallet = document.getElementById('donor-wallet').value.trim() || 'anonymous_donor';
            const description = document.getElementById('description').value.trim() || 'General donation';

            if (!selectedOption.value) {
                alert('Please select a nonprofit organization');
                return;
            }

            // Show processing message
            document.getElementById('fraud-result').innerHTML = `
                <div class="card">
                    <h3>üîÑ Processing Donation...</h3>
                    <p>Analyzing $${amount.toFixed(2)} donation for fraud indicators...</p>
                    <p><em>Running AI fraud detection algorithms...</em></p>
                </div>
            `;

            // Simulate processing delay
            await new Promise(resolve => setTimeout(resolve, 2000));

            // Calculate fraud score
            const nonprofitStatus = selectedOption.dataset.status;
            const nonprofitName = selectedOption.dataset.name;
            const fraudScore = calculateFraudScore(amount, nonprofitStatus, donorWallet);
            const risk = classifyRisk(fraudScore);
            const status = getStatusFromScore(fraudScore);

            // Create transaction record
            const transaction = {
                nonprofitName: nonprofitName,
                amount: amount,
                fraudScore: fraudScore,
                status: status,
                date: new Date(),
                donorWallet: donorWallet,
                description: description
            };

            // Add to history
            transactionHistory.unshift(transaction);

            // Generate unique transaction ID
            const transactionId = 'TX' + Date.now().toString(36).toUpperCase();

            // Display results
            const fraudPercentage = (fraudScore * 100).toFixed(1);
            let riskMessage = '';
            
            if (risk.level === 'HIGH') {
                riskMessage = '<p style="color: #721c24;"><strong>üö® HIGH RISK: Transaction flagged for manual review!</strong></p><p>Multiple fraud indicators detected. Compliance team notified.</p>';
            } else if (risk.level === 'MEDIUM') {
                riskMessage = '<p style="color: #856404;"><strong>‚ö†Ô∏è MEDIUM RISK: Additional verification required.</strong></p><p>Some suspicious patterns detected. Enhanced monitoring applied.</p>';
            } else {
                riskMessage = '<p style="color: #155724;"><strong>‚úÖ LOW RISK: Transaction approved and processed.</strong></p><p>No fraud indicators detected. Donation processed successfully.</p>';
            }

            document.getElementById('fraud-result').innerHTML = `
                <div class="card" style="background: ${risk.level === 'HIGH' ? '#f8d7da' : risk.level === 'MEDIUM' ? '#fff3cd' : '#d4edda'}; border-left: 5px solid ${risk.color};">
                    <h3>${risk.icon} Fraud Analysis Complete</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0;">
                        <div>
                            <p><strong>Nonprofit:</strong> ${nonprofitName}</p>
                            <p><strong>Amount:</strong> $${amount.toFixed(2)}</p>
                        </div>
                        <div>
                            <p><strong>Fraud Score:</strong> ${fraudPercentage}%</p>
                            <p><strong>Risk Level:</strong> <span style="color: ${risk.color}; font-weight: bold;">${risk.level}</span></p>
                        </div>
                        <div>
                            <p><strong>Status:</strong> <span style="color: ${risk.color}; font-weight: bold;">${status.toUpperCase()}</span></p>
                            <p><strong>Transaction ID:</strong> ${transactionId}</p>
                        </div>
                    </div>
                    ${riskMessage}
                </div>
            `;

            // Clear form
            e.target.reset();
            loadNonprofits();
            loadTransactionHistory();
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadNonprofits();
            loadTransactionHistory();
        });
    </script>
</body>
</html>